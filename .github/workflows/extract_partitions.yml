name: Extract Partitions from Firmware

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: 'Firmware ZIP URL'
        required: true
        type: string
      partitions:
        description: 'Partitions to extract (comma separated, e.g., boot,init_boot,vendor_boot)'
        required: true
        default: 'boot'
        type: string

jobs:
  extract:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget xz-utils unzip

      - name: Download payload-dumper-go
        run: |
          wget https://github.com/ssut/payload-dumper-go/releases/download/1.3.0/payload-dumper-go_1.3.0_linux_amd64.tar.gz
          tar -zxvf payload-dumper-go_1.3.0_linux_amd64.tar.gz
          chmod +x payload-dumper-go

      - name: Download Firmware
        run: |
          echo "开始下载固件..."
          # 使用 curl 的进度条模式，在 Actions 日志中非常简洁
          curl -L -o firmware.zip "${{ github.event.inputs.firmware_url }}" --progress-bar
          echo "下载完成!"


      - name: Extract payload_properties.txt and payload.bin
        run: |
          echo "正在解压 payload 文件..."
          unzip -q firmware.zip payload_properties.txt payload.bin -d . || unzip -q firmware.zip payload.bin -d .
          
          if [ -f "payload_properties.txt" ]; then
            echo "--- Payload Properties ---"
            cat payload_properties.txt
            DEVICE_MODEL=$(grep "ota_target_version" payload_properties.txt | cut -d'=' -f2)
            echo "DEVICE_MODEL=$DEVICE_MODEL" >> $GITHUB_ENV
          fi
          
          echo "Payload 文件解压完成!"
          ls -lh payload.bin

      - name: Extract Partitions
        run: |
          echo "开始提取分区: ${{ github.event.inputs.partitions }}"
          mkdir -p output
          ./payload-dumper-go -p "${{ github.event.inputs.partitions }}" -o output payload.bin

      - name: Prepare Release Assets
        run: |
          cd output
          echo "提取的分区文件:"
          ls -lh

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "extract-${{ github.run_id }}"
          name: "Extracted Partitions for ${{ env.DEVICE_MODEL || 'Unknown Device' }}"
          body: |
            Extracted from: ${{ github.event.inputs.firmware_url }}
            Partitions: ${{ github.event.inputs.partitions }}
          files: |
            output/*
            payload_properties.txt
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
